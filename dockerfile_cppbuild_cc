FROM ubuntu:22.04

# 设置环境变量
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Asia/Shanghai \
    MCP_CLIENT_DOCKER=true

# 配置镜像源和安装基础包（合并减少层数）
RUN apt-get update && \
    apt-get install -y ca-certificates && \
    sed -i 's|http://archive.ubuntu.com/ubuntu/|http://mirrors.aliyun.com/ubuntu/|g' /etc/apt/sources.list && \
    sed -i 's|http://security.ubuntu.com/ubuntu/|http://mirrors.aliyun.com/ubuntu/|g' /etc/apt/sources.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        # 基础工具
        curl wget tar cmake build-essential vim git tree \
        gdb valgrind strace pkg-config \
        # 网络工具
        net-tools netstat-nat clang \
        # Python相关
        python3-dev python3-pip \
        # 科学计算库
        libeigen3-dev libfftw3-dev \
        gsl-bin libgsl-dev \
        liblapack-dev libblas-dev \
        # GPG工具（PPA需要）
        gnupg2 gpg-agent \
        # 权限管理工具
        sudo \
        # 其他工具
        openssh-server && \
    # 清理缓存
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# 创建用户组wnk和用户wnk，并配置sudo权限
RUN groupadd -g 1000 wnk && \
    useradd -u 1000 -g wnk -G sudo -m -s /bin/bash wnk && \
    echo 'wnk ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers && \
    echo 'wnk:wnk' | chpasswd

# 下载并安装 Node.js 和 npm
RUN wget -O node.tar.xz https://registry.npmmirror.com/-/binary/node/latest-v22.x/node-v22.17.0-linux-x64.tar.xz && \
    tar -xf node.tar.xz -C /usr/local --strip-components=1 && \
    rm node.tar.xz

# 验证安装
RUN node -v && npm -v && npm config set registry https://registry.npmmirror.com

# 配置pip镜像源和安装Python包
RUN pip3 config set global.index-url http://mirrors.aliyun.com/pypi/simple/ && \
    pip3 config set global.trusted-host mirrors.aliyun.com && \
    python3 -m pip install --upgrade pip

# 全局安装 @anthropic-ai/claude-code
RUN npm install -g @anthropic-ai/claude-code

# 配置Git安全设置，解决dubious ownership问题
RUN git config --global --add safe.directory '*' && \
    git config --global user.name "wnk" && \
    git config --global user.email "wnk@localhost"

# 设置工作目录为wnk用户的home目录
WORKDIR /home/wnk

# 切换到wnk用户
USER wnk

# 为wnk用户也配置Git安全设置
RUN git config --global --add safe.directory '*' && \
    git config --global user.name "wnk" && \
    git config --global user.email "wnk@localhost"
