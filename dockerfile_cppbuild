FROM ubuntu:22.04

# 设置环境变量
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Asia/Shanghai \
    MCP_CLIENT_DOCKER=true

# 配置镜像源和安装基础包（合并减少层数）
RUN apt-get update && \
    apt-get install -y ca-certificates && \
    sed -i 's|http://archive.ubuntu.com/ubuntu/|http://mirrors.aliyun.com/ubuntu/|g' /etc/apt/sources.list && \
    sed -i 's|http://security.ubuntu.com/ubuntu/|http://mirrors.aliyun.com/ubuntu/|g' /etc/apt/sources.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        # 基础工具
        curl wget tar cmake build-essential vim git tree \
        gdb valgrind strace pkg-config \
        # 网络工具
        net-tools netstat-nat clang \
        # Python相关
        python3-dev python3-pip \
        # 科学计算库
        libeigen3-dev libfftw3-dev \
        gsl-bin libgsl-dev \
        liblapack-dev libblas-dev \
        # GPG工具（PPA需要）
        gnupg2 gpg-agent \
        # 其他工具
        openssh-server && \
    # 清理缓存
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
    
# 下载并安装 Node.js 和 npm
RUN wget -O node.tar.xz https://registry.npmmirror.com/-/binary/node/latest-v22.x/node-v22.17.0-linux-x64.tar.xz && \
    tar -xf node.tar.xz -C /usr/local --strip-components=1 && \
    rm node.tar.xz

# 验证安装
RUN node -v && npm -v && npm config set registry https://registry.npmmirror.com

# 配置pip镜像源和安装Python包
RUN pip3 config set global.index-url http://mirrors.aliyun.com/pypi/simple/ && \
    pip3 config set global.trusted-host mirrors.aliyun.com && \
    python3 -m pip install --upgrade pip


# Create app directory
WORKDIR /usr/src/app

# Copy package.json and package-lock.json
COPY package*.json ./

# Install dependencies without triggering any unwanted scripts
RUN npm install --ignore-scripts

# Run post-install script for @vscode/ripgrep to download the binary
RUN npm rebuild @vscode/ripgrep

# Copy all source code
COPY . .

# Build the application
RUN npm run build

# Command to run the server
CMD [ "node", "/usr/src/app/dist/index.js" ]
